# Kuka ROS Tutorial - Microservices

[Home](../README.md)

## Content
- [MoveIt! - RViz Support Services](#moveit---rviz-support-services)
- [End Effector State Services ](#end-effector-state-services)
    - [Current Cartesian Pose](#end-effector-current-cartesian-pose-inquiry)
    - [Current Cartesian State](#end-effector-current-cartesian-state-inquiry)
    - [Path Recording](#end-effector-path-recording)
    - [Wrench Visulization](#end-effector-wrench-visulization)

- [Special Services of iiwa_stack_cam](#special-services-of-iiwastackcam)
    - [Software Level Emergency Stop](#software-level-emergency-stop)
    - [Get Frames from Pendant](#get-frames-from-pendant)

- [Services from Original iiwa_stack](#services-from-original-iiwastack)
    - [Configure Control Mode](#configure-control-mode)
    - [Set Endpoint Frame](#set-endpoint-frame)


## MoveIt! - RViz Support Services

 - **Service 1**: `moveit_rviz_state_receiver_service`  
   **Source File**: [moveit_rviz_state_receiver_service.cpp](../src/utilities/moveit_rviz_state_receiver_service.cpp)  
   **Description**: Get joint position from real robot (specified by robot name) and visualize the state on RVIZ

 - **Service 2**: `moveit_rviz_exec_service`  
   **Source File**: [moveit_rviz_exec_service.cpp](../src/utilities/moveit_rviz_exec_service.cpp)  
   **Description**: Get joint space trajectory plan by moveit, execute it (require specifying robot name)


-  **Note**: For multiple robots, you may need to change the source code of services above (the topic name that RViz publishes and receivers)

  1. Load the manipulator into RViz:   
    `roslaunch iiwa_moveit_cam demo.launch`  
    Here we are using demo file (`demo.launch`) generated by the [MoveIt setup assistant](http://docs.ros.org/en/kinetic/api/moveit_tutorials/html/doc/setup_assistant/setup_assistant_tutorial.html).   
    The  file is adapted to disable the default joint_state_publisher

  1. Visualize the real robot state on RVIZ:   
    `rosrun iiwa_cam moveit_rviz_state_receiver_service [robot name]`  

  1. Execute joint space trajectory plan by moveit:  
    `rosrun iiwa_cam moveit_rviz_exec_service [robot name]` 

  1. The above steps are integrated into a launch file [moveit_kuka.launch](../launch/moveit_kuka.launch), run it with:  
    `roslaunch iiwa_cam moveit_kuka.launch`

      ```xml
      <launch>

        <!-- run a modified moveit demo lauch file -->
        <!-- the node "joint_state_publisher" is disabled -->
        <include file="$(find iiwa_moveit_cam)/launch/demo.launch"/>

        <node pkg="iiwa_cam" type="moveit_rviz_exec_service" name="moveit_rviz_exec_service" output="screen"/>
      
        <node pkg="iiwa_cam" type="moveit_rviz_state_receiver_service" name="moveit_rviz_state_receiver_service" output="screen"/>

      </launch>

      ```


## End Effector State Services 

 - **Service**: `end_effector_state_service`  
 - **Source File**: [end_effector_state_service.cpp](../src/utilities/end_effector_state_service.cpp)  
 - **Run the microservice**:  
    `rosrun iiwa_cam end_effector_state_service [robot1 name] [robot2 name] ...`  

 ### End Effector Current Cartesian Pose Inquiry
 To get the current cartesian Pose, there are two options:

  1. In a terminal:  
    call service `/cam/iiwa/EndEffectorPose`, with parameters:   
    `robot_name: [robot name]`  

  1. In C++ program:  
    call `cam::Kuka::end_effector_state()::get_cart_pose()` 
      ```cpp
      auto cart_pose = kuka.end_effector_state().get_cart_pose();
      std::cout<<cart_pose.first<<std::endl;
      ```
 ### End Effector Current Cartesian State Inquiry
 To get the current cartesian state:

  1. In a terminal:  
    call service `/cam/iiwa/EndEffectorState`, with parameters:   
    `robot_name: [robot name]`  
  
### End Effector Path Recording

  **Watchdog Machanism** （Daemon）:  
  - [Wikipedia: Watchdog timer](https://en.wikipedia.org/wiki/Watchdog_timer)
  - The watchdog machanism is introduced to this server, which allows the server stop recording when a client crashes. Once the client setup a watchdog, it should feed the dog with a frequency higher than **0.2** Hz （recommend 4 seconds between two feeds)

  **Note**: The data is saved in your terminal's current working directory  
  - cartesian path: `[robot name]_cart_path.csv`  
  - wrench: `[robot name]_wrench.csv`  

  To record path of the end effector, there are three options:
  
  1.  In a terminal:
      - Start recording by calling service `/cam/iiwa/PathRecorder`, with parameters:   
      `robot_name: [robot name]`  
      `record: true`  
      `watchdog: false`
      - Stop recording by calling service `/cam/iiwa/PathRecorder`, with parameters:   
      `robot_name: [robot name]`  
      `record: false`  
      `watchdog: false`  

  1. In a terminal: (protected by the **watchdog machanism**)  
      - Start recording by calling service `/cam/iiwa/PathRecorder`, with parameters:   
      `robot_name: [robot name]`  
      `record: true`  
      `watchdog: true`

      - Feed dog by calling service `/cam/iiwa/PathRecorder`, with parameters:  
      （recommend 4 seconds between two feeds)  
      `robot_name: [robot name]`  
      `record: true`  
      `watchdog: true`

      - Stop recording by calling service `/cam/iiwa/PathRecorder`, with parameters:   
      `robot_name: [robot name]`  
      `record: false`  
      `watchdog: true`  

  1.  In C++ program: (protected by the **watchdog machanism**)  
    call `cam::Kuka::end_effector_state()::start_recording()` and `cam::Kuka::end_effector_state()::end_recording()`
      ```cpp
      kuka.end_effector_state().start_recording();
      // Do Something
      kuka.end_effector_state().end_recording();
      ```
    

### End Effector Wrench Visulization


  1. In terminal, run: (in order to load the manipulator into RViz, you can do this in other ways)  
    `roslaunch iiwa_cam moveit_kuka.launch`  


  1. In RVIZ, click "`Add`" button -> in the "`By topic`" tab -> select  
  `/[robot name]/state/EndEffectorWrench`



## Special Services of iiwa_stack_cam
Based on original iiwa_stack, we developed several special features for Kuka

### Software Level Emergency Stop
1. In a terminal, call service: `/[robot name]/EmergencyStop` and the `ROSSmartServo` application on the pendant will pause
1. After the application paused, you can either resume the application(the robot will resume the previous motion) or exit it 



### Get Frames from Pendant
1. In a terminal, call service: `/[robot name]/configuration/GetFrames`


## Services from Original iiwa_stack

### Configure Control Mode
- **Service**: `ConfigureControlMode`  
1. In a terminal, call service: `/[robot name]/configuration/ConfigureControlMode`   
1. Select control mode using number 0 ~ 4:
    - control_mode = 0: Position Control Mode
    - control_mode = 1: Joint Impedance Control Mode (use joint_impedance)
    - control_mode = 2: Cartesian Impedance Control Mode (use cartesian_impedance and limits)
      - recommended param:  _nullspace_stiffness: 100.0, nullspace_damping: 0.7_ 
    - control_mode = 3: Cartesian Sine Impedance Control Mode (use desired_force and limits)
    - control_mode = 4: Cartesian Sine Impedance Control Mode (use sine_pattern and limits)

### Set Endpoint Frame
- **Service**: `setEndpointFrame`  
- **Note**: 
    - After changing the endpoint frame, the topic `/[robot name]/state/CartesianPose` will show the new frame's cartesian position
    - After changing the endpoint frame, when moving to a cartesian position, the manipulator will move the frame of the tool to the goal position
#### Sunrise Workbench Setting
1. Add a tool (refer to Kuka mannual), suppose the tool name is `[your tool name]`
1. Add a base frame `[your tool name]_link_ee`   
    (this will be the initial frame the manipulator uses for cartesian pose)
1. Add other frame on your tool
1. Synchronize the project


#### ROS Side
1. In a terminal, add a parameter: `rosparam set iiwa/toolName [your tool name]`  
    or using lauch file:
    ```xml
    <arg name="tool_name" default="[your tool name]"/>
    <param name="/iiwa/toolName" type="string" value="$(arg tool_name)" />
    ```
1. In a terminal, call service: `/[robot name]/configuration/setEndpointFrame`  
1. Set `frame_id` to the desired frame which belongs to this tool 













